#!/usr/bin/python

import os
import sys
import pwd
import uuid
import struct
import socket
import logging
import base64
import tempfile
import time

from socket import socket, AF_UNIX, SOCK_STREAM, SOL_SOCKET

logger = logging.getLogger("libclient")

LOCAL_PATH = tempfile.gettempdir() + "/cloudauth.sk"

SO_PASSCRED = 16 # Pulled from /usr/include/asm-generic/socket.h

def assert_authnz():

    s = socket(AF_UNIX, SOCK_STREAM)

    s.setsockopt(SOL_SOCKET, SO_PASSCRED, 1)

    s.connect(LOCAL_PATH)

    s.send("GET /authz?ttype=qst&srvs=az&srvs=jz HTTP/1.1\r\nContent-length:0\r\nConnection:keep-alive\r\nHost:localhost\r\n\r\n");

    logger.info("recving 1st")

    data = s.recv(81920)

    logger.info("recv'd 1st")

    logger.info("FIRST: %s", data)     

    data = s.recv(81920)
    logger.info("FIRST: %s", data)     

    s.send("GET /authz?ttype=qst&srvs=foo&srvs=bar HTTP/1.1\r\nContent-length:0\r\nConnection:keep-alive\r\nHost:localhost\r\n\r\n");

    logger.info("recving 2nd")

    data = s.recv(81920)

    logger.info("recv'd 2nd")

    logger.info("SECOND: %s", data)     

    data = s.recv(81920)
    logger.info("SECOND: %s", data)     
    data = s.recv(81920)
    logger.info("SECOND: %s", data)     

    s.close()

# Entrance for stand-alone execution
def main():

    logging.basicConfig(format='%(asctime)s %(levelname)s %(name)s %(message)s', level=logging.INFO) 

    assert_authnz()

if __name__ == "__main__":
    
    main()
